@startuml
'https://plantuml.com/class-diagram

class PeerConnectionObserver {
    - gcs_connector: GCSConnector
    - pc_manager: PeerConnectionManager
    + PeerConnectionObserver(gcs_connector: GCSConnector,
                            pc_manager: PeerConnectionManager)

    + OnDataChannel(data_channel: DataChannel)
    + OnIceCandidate(candidate: IceCandidate)
    + OnStandardizedIceConnectionChange(new_state: IceConnectionState)
    + OnIceGatheringChange(new_state: IceGatheringState)
    + OnSignalingChange(new_state: SignalingState)
    + OnConnectionChange(new_state: PeerConnectionState)
}

class GCSConnectorFactory {
    - robot_id: String
    - user_id: String
    - ice_config: IceConfig
    - signaling_config: SignalingConfig
    + GCSConnectorFactory(robot_id: String, user_id: String,
                        signaling_config: SignalingConfig, ice_config: IceConfig)
    + GCSConnectorFactory(robot_id: String, user_id: String, ws_uri: String,
                        turn_url: String, turn_username: String, turn_credential: String)
    + Create(): GCSConnector
}

struct IceConfig {
    - turn_url: std::string
    - turn_username: std::string
    - turn_credential: std::string
    + IceConfig(url: String, username: String, credential: String)
}

struct SignalingConfig {
    - ws_uri: String
    - robot_id: String
    + SignalingConfig(ws_uri: String, robot_id: String)
    + GetSignalingUrl(): String
}

interface IGCSAuthenticator {
}

interface ISignalingClient {
    + Start()
    + Stop()
    + SendSdpAnswer(sdp_answer: SessionDescription)
    + SendIceCandidate(candidate: IceCandidate)
    + SendState(state: String)
    + SetGCSConnector(gcs_connector: GCSConnector)
    + SetAuthenticator(authenticator: IGCSAuthenticator)
    + IsAuthenticated(): Boolean
}

class SignalingClient {
    - gcs_connector: GCSConnector
    - gcs_authenticator: IGCSAuthenticator
    - ws_client: WebSocketClient
    - is_connected: Boolean
    - is_authenticated: Boolean
    - ws_uri: String

    + SignalingClient(ws_uri: String)
    + Start()
    + Stop()
    + SendSdpAnswer(sdp_answer: SessionDescription)
    + SendIceCandidate(candidate: IceCandidate)
    + SendState(state: String)
    + SetGCSConnector(gcs_connector: GCSConnector)
    + SetAuthenticator(authenticator: IGCSAuthenticator)
    + IsAuthenticated(): Boolean

    - StartInternal()
    - OnWsMessage(message: String)
    - OnMessage(message: Json)
    - SendWsMessage(message: Json)

    - ResolveIceCandidate(ice_candidate: Json): IceCandidate
    - ResolveSdpOffer(sdp_offer: Json): SessionDescription
}

class ConnectorStateManager {
    - state: ClientState
    - signaling_client: ISignalingClient

    + ConnectorStateManager(signaling_client: ISignalingClient)
    + GetState(): ClientState
    + SetState(new_state: ClientState)
    + GetStateString(): String
    + IsState(expected_state: ClientState): Boolean

    - LogState(old_state: ClientState, new_state: ClientState)
    - SendStateToSignalingServer()
    - StateToString(state: ClientState): String
}

enum ClientState {
    INITIALIZING
    READY_TO_CONNECT
    CONNECTING
    CONNECTED
    DISCONNECTING
    FAILED
    SHUTTING_DOWN
}

class GCSConnector {
    - robot_id: String
    - user_id: String
    - pc_manager: PeerConnectionManager
    - state_manager: ConnectorStateManager
    - data_channel_handlers_dict: Dict<String, IDataChannelHandler>
    - media_track_handlers_dict: Dict<String, IMediaTrackHandler>

    + GCSConnector(robot_id: String, user_id: String)
    + GetRobotId(): String
    + GetUserId(): String
    + SetPeerConnectionManager(peer_connection_manager: PeerConnectionManager)
    + InitializeWebRTC()
    + AddDataChannelHandler(handler: ADataChannelHandler)
    + AddMediaTrackHandler(handler: IMediaTrackHandler)
    + ClosePeerConnection()
    + ShuttingDown()

    + HandleSdpOffer(sdp_offer: SessionDescription)
    + HandleIceCandidateFromSignaling(candidate: IceCandidate)

    - OnDataChannel(data_channel: DataChannel)
    - GetStateManager(): ClientStateManager
    - CreateAllMediaTracks()
    - CloseAllMediaTracks()
    - CloseAllDataChannels()
    - GetImpl(): Impl
}

class PeerConnectionManager {
    - client: GCSConnector
    - state_manager: ClientStateManager
    - ice_config: IceConfig
    - signaling_client: ISignalingClient

    - peer_connection_factory: PeerConnectionFactoryInterface
    - peer_connection: PeerConnectionInterface
    - peer_connection_observer: PeerConnectionObserver

    + PeerConnectionManager(client: GCSConnector, state_manager: ClientStateManager,
                            signaling_client: ISignalingClient, ice_config: IceConfig)
    + InitializeWebRTC()
    + CreatePeerConnection()
    + HandleSdpOffer(sdp_offer: SessionDescription)
    + AfterSetSessionDescription()
    + AfterCreateSdpAnswer(desc: SessionDescription)
    + AfterSetLocalDescription(desc: SessionDescription)
    + HandleIceCandidateFromSignaling(candidate: IceCandidate)
    + OnConnectionConnected()
    + OnConnectionDisconnected()
    + SendIceCandidate(candidate: IceCandidate)
    + StopSignalingServer()
    + ClosePeerConnection()
    + DestroyPeerConnectionManager()

    - CreateVideoTrack(source: VideoTrackSourceInterface, label: String): VideoTrackInterface
    - AddTrack(track: MediaStreamTrackInterface, stream_ids: String[]): RtpSenderInterface
    - GetImpl(): Impl
}

interface handler.dc.IDataChannelHandler {
}
interface handler.media.IMediaTrackHandler {
}

GCSConnector "1" *-- "many" IDataChannelHandler
GCSConnector "1" *-- "many" IMediaTrackHandler

ISignalingClient -* ConnectorStateManager

SignalingClient *- IGCSAuthenticator

GCSConnector *- ConnectorStateManager
ConnectorStateManager <- ClientState

PeerConnectionObserver -* PeerConnectionManager
webrtc_PeerConnectionObserver <|- PeerConnectionObserver

ISignalingClient <|. SignalingClient
PeerConnectionManager *- ISignalingClient

GCSConnectorFactory ->  GCSConnector
PeerConnectionManager --* GCSConnector
GCSConnectorFactory -- IceConfig
GCSConnectorFactory -- SignalingConfig

@enduml